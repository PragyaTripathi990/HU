<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Account Connection - Saafe Dashboard</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Consent Dashboard Styles with Glassmorphism */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
    }

    .consent-dashboard {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .dashboard-container {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .dashboard-title {
      text-align: center;
      color: white;
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .dashboard-subtitle {
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1rem;
      margin-bottom: 3rem;
    }

    /* Glassmorphism Card */
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 2.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
    }

    .success-card {
      background: rgba(76, 175, 80, 0.15);
      border: 1px solid rgba(76, 175, 80, 0.3);
    }

    /* Stepper Indicator */
    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 3rem;
      padding: 0 2rem;
    }

    .stepper-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .stepper-number {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 700;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .stepper-step.active .stepper-number {
      background: rgba(255, 255, 255, 0.9);
      color: #667eea;
      border-color: rgba(255, 255, 255, 0.9);
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
    }

    .stepper-label {
      margin-top: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .stepper-step.active .stepper-label {
      color: white;
      font-weight: 600;
    }

    .stepper-line {
      flex: 1;
      height: 2px;
      background: rgba(255, 255, 255, 0.2);
      margin: 0 1rem;
      transition: all 0.3s ease;
    }

    .stepper-line.active {
      background: rgba(255, 255, 255, 0.6);
    }

    /* Form Styles */
    .card-title {
      color: white;
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 2rem;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .form-input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.5);
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
    }

    .form-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .form-input.disabled {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
      cursor: not-allowed;
    }

    /* Buttons */
    .btn-primary,
    .btn-secondary {
      width: 100%;
      padding: 1rem 2rem;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .btn-primary {
      background: rgba(255, 255, 255, 0.9);
      color: #667eea;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-primary:hover:not(:disabled) {
      background: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .status-badge.pending {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .success-badge {
      background: rgba(76, 175, 80, 0.2);
      color: #4caf50;
      border: 1px solid rgba(76, 175, 80, 0.3);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Info Section */
    .info-section {
      margin-bottom: 2rem;
    }

    .info-text {
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .url-display {
      margin-bottom: 2rem;
    }

    .url-display label {
      display: block;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .url-box {
      padding: 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
      word-break: break-all;
      font-family: 'Courier New', monospace;
    }

    .status-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .polling-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Success Card */
    .success-icon {
      font-size: 4rem;
      text-align: center;
      margin-bottom: 1rem;
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }

    .success-message {
      text-align: center;
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1rem;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .success-details {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 500;
    }

    .detail-value {
      color: white;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
    }

    .action-buttons .btn-primary,
    .action-buttons .btn-secondary {
      flex: 1;
      margin-top: 0;
    }

    /* Error Card */
    .error-card {
      background: rgba(244, 67, 54, 0.15);
      border: 1px solid rgba(244, 67, 54, 0.3);
      margin-bottom: 2rem;
    }

    .error-icon {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .error-message {
      color: white;
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    .error-hint {
      background: rgba(0, 0, 0, 0.2);
      padding: 1rem;
      border-radius: 10px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .error-hint code {
      background: rgba(0, 0, 0, 0.3);
      padding: 0.2rem 0.5rem;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      display: block;
      margin-top: 0.5rem;
    }

    .status-info {
      text-align: center;
      margin-bottom: 2rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .consent-dashboard {
        padding: 1rem;
      }

      .dashboard-title {
        font-size: 2rem;
      }

      .glass-card {
        padding: 1.5rem;
      }

      .stepper {
        padding: 0 1rem;
      }

      .stepper-number {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const ConsentDashboard = () => {
      const [step, setStep] = useState(1);
      const [mobile, setMobile] = useState('9898989898');
      const [internalUserId] = useState(`user-${Date.now()}`);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      
      const [consentData, setConsentData] = useState(null);
      const [redirectUrl, setRedirectUrl] = useState(null);
      const [requestId, setRequestId] = useState(null);
      
      const [status, setStatus] = useState('PENDING');
      const [polling, setPolling] = useState(false);
      
      const [consentId, setConsentId] = useState(null);

      const API_BASE_URL = 'http://localhost:3000';

      const handleInitiateConsent = async () => {
        setLoading(true);
        setError(null);
        
        try {
          const response = await fetch(`${API_BASE_URL}/internal/aa/consents/initiate`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              internal_user_id: internalUserId,
              mobile: mobile,
              email: 'user@example.com',
              date_of_birth: '1990-01-01',
              pan_number: 'ABCDE1234F',
              aa_id: ['dashboard-aa-preprod'],
              fi_types: ['DEPOSIT'],
              consent_start_date: new Date().toISOString().split('T')[0],
              consent_expiry_date: new Date(Date.now() + 6 * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              fi_datarange_from: new Date(Date.now() - 3 * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              fi_datarange_to: new Date().toISOString().split('T')[0],
              purpose_code: '102',
              consent_mode: 'STORE',
              consent_types: ['PROFILE', 'SUMMARY', 'TRANSACTIONS'],
              fetch_type: 'PERIODIC',
              frequency_unit: 'MONTH',
              frequency_value: 1
            }),
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || 'Failed to initiate consent');
          }

          setConsentData(data.data);
          setRedirectUrl(data.data.redirect_url);
          setRequestId(data.data.request_id);
          setStep(2);
        } catch (err) {
          console.error('Error initiating consent:', err);
          setError(err.message || 'Failed to initiate consent. Please check CORS settings and ensure the server is running.');
        } finally {
          setLoading(false);
        }
      };

      const checkStatus = async () => {
        if (!requestId) return;

        setPolling(true);
        setError(null);

        try {
          const response = await fetch(`${API_BASE_URL}/internal/aa/consents/request/${requestId}`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const data = await response.json();

          if (!response.ok || !data.success) {
            throw new Error(data.error || 'Failed to check status');
          }

          const consent = data.data;
          const currentStatus = consent.status || 'PENDING';
          setStatus(currentStatus);

          if (currentStatus === 'ACTIVE') {
            setConsentId(consent.consent_id || 'N/A');
            setStep(3);
            setPolling(false);
          } else if (currentStatus === 'REJECTED' || currentStatus === 'REVOKED') {
            setError(`Consent was ${currentStatus}`);
            setPolling(false);
          }
        } catch (err) {
          console.error('Error checking status:', err);
          setError(err.message || 'Failed to check status');
          setPolling(false);
        }
      };

      useEffect(() => {
        if (step === 2 && !polling && status !== 'ACTIVE' && requestId) {
          const interval = setInterval(() => {
            checkStatus();
          }, 5000);

          return () => clearInterval(interval);
        }
      }, [step, polling, status, requestId]);

      const handleAuthorize = () => {
        if (redirectUrl) {
          window.open(redirectUrl, '_blank');
        }
      };

      const handleFetchData = () => {
        alert('Fetch Data functionality will be implemented in the next phase');
      };

      return (
        <div className="consent-dashboard">
          <div className="dashboard-container">
            <h1 className="dashboard-title">Bank Account Connection</h1>
            <p className="dashboard-subtitle">Connect your bank account securely via Account Aggregator</p>

            <div className="stepper">
              <div className={`stepper-step ${step >= 1 ? 'active' : ''}`}>
                <div className="stepper-number">1</div>
                <div className="stepper-label">Initiate</div>
              </div>
              <div className={`stepper-line ${step >= 2 ? 'active' : ''}`}></div>
              <div className={`stepper-step ${step >= 2 ? 'active' : ''}`}>
                <div className="stepper-number">2</div>
                <div className="stepper-label">Approve</div>
              </div>
              <div className={`stepper-line ${step >= 3 ? 'active' : ''}`}></div>
              <div className={`stepper-step ${step >= 3 ? 'active' : ''}`}>
                <div className="stepper-number">3</div>
                <div className="stepper-label">Success</div>
              </div>
            </div>

            {error && (
              <div className="error-card glass-card">
                <div className="error-icon">⚠️</div>
                <div className="error-message">{error}</div>
                {error.includes('CORS') && (
                  <div className="error-hint">
                    <strong>Fix CORS:</strong> Ensure your Express backend has CORS enabled:
                    <code>app.use(cors());</code>
                  </div>
                )}
              </div>
            )}

            {step === 1 && (
              <div className="glass-card">
                <h2 className="card-title">Step 1: Initiate Consent</h2>
                <div className="form-group">
                  <label htmlFor="mobile">Mobile Number</label>
                  <input
                    id="mobile"
                    type="text"
                    value={mobile}
                    onChange={(e) => setMobile(e.target.value)}
                    placeholder="Enter mobile number"
                    className="form-input"
                  />
                </div>
                <div className="form-group">
                  <label htmlFor="userId">Internal User ID</label>
                  <input
                    id="userId"
                    type="text"
                    value={internalUserId}
                    disabled
                    className="form-input disabled"
                  />
                </div>
                <button
                  onClick={handleInitiateConsent}
                  disabled={loading || !mobile}
                  className="btn-primary"
                >
                  {loading ? 'Connecting...' : 'Connect Bank Account'}
                </button>
              </div>
            )}

            {step === 2 && (
              <div className="glass-card">
                <h2 className="card-title">Step 2: Authorize on Saafe</h2>
                <div className="status-info">
                  <div className={`status-badge ${status.toLowerCase()}`}>Status: {status}</div>
                </div>
                <div className="info-section">
                  <p className="info-text">
                    Click the button below to authorize the consent on Saafe's secure platform.
                  </p>
                  <button onClick={handleAuthorize} className="btn-primary">
                    Authorize on Saafe
                  </button>
                </div>
                <div className="url-display">
                  <label>Authorization URL:</label>
                  <div className="url-box">{redirectUrl}</div>
                </div>
                <div className="status-section">
                  <button
                    onClick={checkStatus}
                    disabled={polling}
                    className="btn-secondary"
                  >
                    {polling ? 'Checking...' : 'Check Status'}
                  </button>
                  {polling && (
                    <div className="polling-indicator">
                      <div className="spinner"></div>
                      <span>Polling every 5 seconds...</span>
                    </div>
                  )}
                </div>
              </div>
            )}

            {step === 3 && (
              <div className="glass-card success-card">
                <div className="success-icon">✅</div>
                <h2 className="card-title">Connection Successful!</h2>
                <p className="success-message">
                  Your bank account has been successfully connected via Account Aggregator.
                </p>
                <div className="success-details">
                  <div className="detail-item">
                    <span className="detail-label">Consent ID:</span>
                    <span className="detail-value">{consentId || 'N/A'}</span>
                  </div>
                  <div className="detail-item">
                    <span className="detail-label">Status:</span>
                    <span className="success-badge">ACTIVE</span>
                  </div>
                  <div className="detail-item">
                    <span className="detail-label">Request ID:</span>
                    <span className="detail-value">{requestId}</span>
                  </div>
                </div>
                <div className="action-buttons">
                  <button onClick={handleFetchData} className="btn-primary">
                    Fetch Data
                  </button>
                  <button
                    onClick={() => {
                      setStep(1);
                      setStatus('PENDING');
                      setConsentData(null);
                      setRedirectUrl(null);
                      setRequestId(null);
                      setConsentId(null);
                      setError(null);
                    }}
                    className="btn-secondary"
                  >
                    Start New Connection
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    ReactDOM.render(<ConsentDashboard />, document.getElementById('root'));
  </script>
</body>
</html>

